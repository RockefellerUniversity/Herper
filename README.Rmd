---
title: "Herper Guide"
author: "Matt Paul - mpaul@rockefeller.edu"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
package: Herper
output:
 BiocStyle::html_document:
  number_sections: yes
  toc: true
vignette: >
  %\VignetteIndexEntry{Herper}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, results="hide", include = FALSE}
knitr::opts_chunk$set(tidy = FALSE, cache = FALSE, message = FALSE, error = FALSE, warning = TRUE)
options(width = 100)
load(system.file("extdata/Bioc_Pkg_Details.RData", package = "Herper"))
```

<br>

---

## What is Herper?
The Herper package is a simple toolset to install and manage Conda packages and environments from R.

Many R packages require the use of external dependencies. Often these dependencies can be installed and managed with the Conda package repository. For example `r nrow(out_df_deps)` Bioconductor packages have external dependencies listed in their System Requirements field (often with these packages having several requirements) [`r my_date`]. 

<br>

```{r, echo=F, out.width = "1000px", fig.align="center"}
knitr::include_graphics(system.file("extdata/pkg_deps_bar_mask-1.png", package = "Herper"))
```

The Herper package includes functions that allow the easy management of these external dependencies from within the R console.


The Herper package was developed by [Matt Paul](https://github.com/matthew-paul-2006), [Doug Barrows](https://github.com/dougbarrows) and [Thomas Carroll](https://github.com/ThomasCarroll) at the [Rockefeller University Bioinformatics Resources Center](https://rockefelleruniversity.github.io) with contributions from [Katherine Rozen-Gagnon](https://github.com/kathrynrozengagnon).

<br>


## Installation

Use the `BiocManager` package to download and install the package from our Github repository:

```{r getPackage, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
      install.packages("BiocManager")
  }
BiocManager::install("https://github.com/RockefellerUniversity/Herper")
```

<br>
Once installed, load it into your R session:

```{r}
library(Herper)
```




<br>

## Simple install of Conda packages from R console using **install_CondaTools**. 

The **install_CondaTools()** function allows the user to specify required Conda software and the desired environment to install into.

Miniconda is installed as part of the process (by default into the r-reticulate's default Conda location - `r reticulate::miniconda_path()`) and the user's requested conda environment built within the same directory (by default `r file.path(reticulate::miniconda_path(),"envs","USERS_ENVIRONMENT_HERE")`). 

If you already have Miniconda installed or you would like to install to a custom location, you can specify the path with the *pathToMiniConda* parameter.


```{r, echo=F, eval=T}
tempdir2 <- function() {
    gsub("\\", "/", tempdir(), fixed = TRUE)
}
```


```{r installCondaTools, echo=T, eval=T}
myMiniconda <- file.path(tempdir2(), "Test")
myMiniconda
install_CondaTools("salmon", "herper", pathToMiniConda = myMiniconda)
```

<br>
We can add additional tools to our Conda environment by specifying *updateEnv = TRUE*. A vector of tools can be used to install several at once. 


```{r ,updateCondaTools, echo=T, eval=T}

pathToConda <- install_CondaTools(c("samtools", "kallisto"), "herper", updateEnv = TRUE, pathToMiniConda = myMiniconda)

pathToConda
```

<br>
Specific package versions can be installed using conda formatted inputs into the *tools* argument i.e. "salmon==1.3", "salmon>=1.3" or "salmon<=1.3". This can also be used to specifically upgrade or downgrade existing tools in the chosen environment. 

```{r ,versionCondaTools, echo=T, eval=T}

pathToConda <- install_CondaTools("salmon<=1.3", "herper", updateEnv = TRUE, pathToMiniConda = myMiniconda)
```


<br>

## Install R package dependencies with **install_CondaSysReqs**. 
The **install_CondaSysReqs** checks the System Requirements for the specified R package, and uses Conda to install this software. Here we will use a test package contained within Herper. This test package has two System Requirements:

```{r test_package}

testPkg <- system.file("extdata/HerperTestPkg", package = "Herper")
install.packages(testPkg, type = "source", repos = NULL)
utils::packageDescription("HerperTestPkg", fields = "SystemRequirements")
```

The user can simply supply the name of an installed R package, and **install_CondaSysReqs** will install the System Requirements through conda. 
```{r install_CondaSysReqs}

condaPaths <- install_CondaSysReqs("HerperTestPkg", pathToMiniConda = myMiniconda, SysReqsAsJSON = FALSE)
```

By default these packages are installed in a new environment, which has the name name of the R package and its version number. Users can control the environment name using the *env* parameter. As with **install_CondaTools()**, user can control which version of Miniconda with the parameter *pathToMiniConda*, and whether they want to amend an existing environment with the parameter *updateEnv*.

_Note: **install_CondaSysReqs** can handle standard System Requirement formats, but will not work if the package has free form text. In this case just use **install_CondaTools**_ 

<br>

## Using R packages with System Dependencies with **with_CondaEnv**
**with_CondaEnv** allows users to run an R command using a specific conda environment. This will give the R package access to the conda tools, Python, Perl and Java in this environment. This is done without formally activating your environment or initializing your conda. The Python/Perl/Java libraries used can also be controlled with the corresponding parameters __*_additional__.  

To demonstrate this we will use the first command from the [seqCNA](https://www.bioconductor.org/packages/release/bioc/html/seqCNA.html) vignette. This step requires access samtools. If this is not installed there is an error. But if the command is run using **with_CondaEnv**, then seqCNA can find samtools. 
```{r with_condaenv_R}
library(seqCNA)
data(seqsumm_HCC1143)
try(rco <- readSeqsumm(tumour.data = seqsumm_HCC1143), silent = FALSE)
```

```{r, echo=T, eval=F}
install_CondaSysReqs("seqCNA",env="seqCNA",pathToMiniConda=myMiniconda,SysReqsAsJSON=FALSE)
with_CondaEnv("seqCNA", rco <- readSeqsumm(tumour.data=seqsumm_HCC1143)
 ,pathToMiniConda = myMiniconda)

``` 

```{r, echo=F, eval=T}
if(!identical(.Platform$OS.type, "windows")){
install_CondaSysReqs("seqCNA",env="seqCNA",pathToMiniConda=myMiniconda,SysReqsAsJSON=FALSE)
with_CondaEnv("seqCNA", rco <- readSeqsumm(tumour.data=seqsumm_HCC1143)
 ,pathToMiniConda = myMiniconda)
}
``` 

<br>

## Running Conda packages from R console with **with_CondaEnv**

**with_CondaEnv** allows users to run an conda tools from within R. The user simply has to wrap the command in the **system()** or **system2()** functions. 

```{r with_condaenv_conda, echo=T, eval=F}
with_CondaEnv("HerperTestPkg_0.1.0", system2(command = "rmats.py", args = "-h"), pathToMiniConda = myMiniconda)
```

```{r, echo=F, eval=T}
if(!identical(.Platform$OS.type, "windows")){
  with_CondaEnv("HerperTestPkg_0.1.0", system2(command = "rmats.py", args = "-h"), pathToMiniConda = myMiniconda)}
```

## Finding Conda packages with **conda_search**

If the user is unsure of the exact name, or version of a tool available on conda, they can use the **conda_search** function. 

```{r conda_search}
conda_search("salmon", pathToMiniConda = myMiniconda)
```

Specific package versions can be searched for using the conda format i.e. "salmon==1.3", "salmon>=1.3" or "salmon<=1.3". Searches will also find close matches for incorrect queries. Channels to search in can be controlled with *channels* parameter. 

```{r conda_search_nuance}
conda_search("salmon<=1.0", pathToMiniConda = myMiniconda)
conda_search("salm", pathToMiniConda = myMiniconda)
```

<br>

## Export of Conda environments to YAML files using **export_CondaEnv**.

The **export_CondaEnv** function allows the user to export the environment information to a *.yml* file. These environment YAML files contain all essential information about the package, allowing for reproducibility and easy distribution of Conda system configuration for collaboration. 

```{r export}
yml_name <- paste0("herper_", format(Sys.Date(), "%Y%m%d"), ".yml")
export_CondaEnv("herper", yml_name, pathToMiniConda = myMiniconda)
```

<br>

The YAML export will contain all packages in the environment by default. If the user wants to only export the packages that were specifically installed and not their dependencies they can use the *depends* paramter. 
```{r export_rename}
yml_name <- paste0("herper_nodeps_", format(Sys.Date(), "%Y%m%d"), ".yml")
export_CondaEnv("herper", yml_name, depends = FALSE, pathToMiniConda = myMiniconda)
```

<br>

## Import of Conda environments from YAML files using **import_CondaEnv**.

The **import_CondaEnv** function allows the user to create a new conda environment from a *.yml* file. These can be previously exported from **export_CondaEnv**, conda, renv or manually created. 

Users can simply provide a path to the YAML file for import. They can also specify the environment name, but by default the name will be taken from the YAML. 

```{r import}
testYML <- system.file("extdata/test.yml",package="Herper")
import_CondaEnv(yml_import=testYML, pathToMiniConda = myMiniconda)
```

<br>

## Checking for existing environments with **list_CondaEnv**
The **list_CondaEnv** function allows users to check what environments already exist within the given conda build. 

If the User is using multiple builds of conda and wants to check environments across all them, they can include the parameter *allCondas = TRUE*.
```{r list_CondaEnv}
list_CondaEnv(pathToMiniConda = myMiniconda)
```

<br>

## Checking for packages in an environment with **list_CondaPkgs**
The **list_CondaPkgs** function allows users to check what packages are installed in a given environment.
```{r list_CondaPkgs}
list_CondaPkgs("my_test", pathToMiniConda = myMiniconda)
```

<br>
<br>

```{r, echo=F, eval=F, message=F, warning=F}
unlink(dir(".", pattern = "herper_.*.yml"))
```

```{r, echo=F, eval=F, message=F, warning=F}
myMiniconda <- file.path(tempdir(), "Test")
reticulate::conda_remove("herper", packages = NULL, conda = file.path(myMiniconda, "bin", "conda"))
reticulate::conda_remove("herper2", packages = NULL, conda = file.path(myMiniconda, "bin", "conda"))
reticulate::conda_remove("HerperTestPkg_0.1.0", packages = NULL, conda = file.path(myMiniconda, "bin", "conda"))

if (file.exists(file.path(tempdir(), "r-miniconda"))) {
    condaDir <- file.path(tempdir(), "r-miniconda")
    reticulate::conda_remove("herper", packages = NULL, conda = file.path(condaDir, "bin", "conda"))
    reticulate::conda_remove("herpertest", packages = NULL, conda = file.path(condaDir, "bin", "conda"))
}
```

## Acknowledgements
Thank you to Ji-Dung Luo and Wei Wang for testing/vignette review/critical feedback and Ziwei Liang for their support.

<br>

## Session Information

```{r}
sessionInfo()
```
