---
title: "Introduction to Herper"
author: 
- Matt Paul
- Bioinformatics Resource Center - Rockefeller University
- "mpaul@rockefeller.edu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    keep_md: yes
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---


```{r, echo=F}
load("Bioc_Pkg_Details.RData")
```


## What is Herper?
The Herper package is a simple toolset to install and manage Conda packages and environments from R.

Many R packages require the use of external dependencies. Often these dependencies can be installed and managed with the Conda package repository. For example `r nrow(out_df_deps)` Bioconductor packages have external dependencies listed in their System Requirements field (often with these packages having several requirements) [`r my_date`]. 

---

```{r, echo=F}
knitr::include_graphics("imgs/pkg_deps_bar_mask-1.png")

```

---

The Herper package includes functions that allow the easy management of these external dependencies from within the R console.

---
## Installation

Use the `BiocManager` package to download and install the package from our Github repository:

```{r getPackage, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("https://github.com/RockefellerUniversity/CondaSysReqs")
```

Once installed, load it into your R session:

```{r}
library(CondaSysReqs)
```


---
## Simple install of Conda packages from R console using **install_CondaTools**. 

The **install_CondaTools()** function allows the user to specify required Conda software and the desired environment to install into.

Miniconda is installed as part of the process (by default into the r-reticulate's default Conda location). If you already have Miniconda installed you specify the path with the *pathToMiniConda* parameter.

```{r, echo=F, eval=T}
install_CondaTools("salmon", "myCondaToolSet", pathToMiniConda="/tmp/")
```
```{r, echo=T, eval=F}
install_CondaTools("salmon", "myCondaToolSet")
```

We can add additional tools to our Conda environment by specifying *updateEnv = TRUE*.
```{r, echo=F, eval=T}
pathToConda <- install_CondaTools("macs2", "myCondaToolSet", updateEnv = TRUE, pathToMiniConda="/tmp/")
pathToConda
```
```{r, echo=T, eval=F}
pathToConda <- install_CondaTools("macs2", "myCondaToolSet", updateEnv = TRUE)
pathToConda
```



---
## Simple install of R package dependencies using **install_CondaSysReqs**.



---
## Export of Conda environments to YAML files using **export_CondaEnv**.

The **export_CondaEnv** function allows the user to export the environment information to a *.yml* file. These environment YAML files contain all essential information about the package, allowing for reproducibilty and easy distribution of Conda system configuration for collaboration. 

```{r}
yml_name <- paste0("myCondaToolSet_", format(Sys.Date(), "%Y%m%d"),".yml")
export_CondaEnv("myCondaToolSet", yml_name)
```
---
The YAML export will contain all packages in the environment by default. If the user wants to only export the packages that were specifically installed and not their dependencies they can use the *depends* paramter. 
```{r}
yml_name <- paste0("myCondaToolSet_nodeps_", format(Sys.Date(), "%Y%m%d"),".yml")
export_CondaEnv("myCondaToolSet", yml_name, depends=FALSE)
```

---
## Import of Conda environments from YAML files using **import_CondaEnv**.

The **import_CondaEnv** function allows the user to create a new conda environment from a *.yml* file. These can be previously exported from **export_CondaEnv**, conda, renv or manually created. 

Users can simply provide a path to the YAML file for import. They can also specify the environment name, but by default the name will be taken from the YAML. 

```{r}
import_CondaEnv(yml_name, "myCondaToolSet2")
```

---
## Using R packages with System Dependencies

```{r}


#use_condaenv() 
```

---
## Running Conda packages from R console.

Although we will not activate the environment, many tools can be used straight from the Conda environment's bin directory. When the result of **install_CondaTools()** is assigned to a variable, it will contain the path to the bin directory for that environment. Users can then run these tools with **System()** commands

```{r}
pathToSalmon <- file.path(pathToConda$pathToEnvBin, "salmon")
pathToSalmon
Salmon_help <- system(paste(pathToSalmon,"-h"), intern = TRUE)
Salmon_help
```

## Session Information

```{r}
devtools::session_info()
```